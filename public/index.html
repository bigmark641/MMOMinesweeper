<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        #board {
            margin-top: 50px;
        }

        .row {
            display: table-row;
        }

        .cell {
            display: table-cell;
            height: 50px;
            width: 50px;
            border: 1px solid black;
            text-align: center;
            vertical-align: middle;
            font-size: 36px;
        }

        .cell.unknown {
            background-color: lightblue;
        }

        .cell.flagged {
            background-color: yellow;
            color: red;
        }

        .cell.revealed {
            background-color: white;
        }

        #remaining-mines {
            position: fixed;
            top: 0px;
            left: 44%;
            margin-left: auto;
            margin-right: auto;
            padding: 6px;
            background: rgba(255, 255, 255, .5);
            border: 2px solid black;
            color: red;
            font-size: 30px;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="remaining-mines">Remaining mines:
        <span id="remaining-mine-count"></span>
    </div>
    <div id="board">
    </div>
    <script>
        (function () {

            //Initialize socket
            var socket = io.connect();

            //Initialize remote function handlers
            socket.on('setBoardData', function (data) {
                displayBoardHtml(data.revealedBoard, data.remainingMineCount);
            });
            socket.on('win', function (data) {
                alert('You win!!!');
            });

            //Initialize game
            var boardElement = document.getElementById('board');
            socket.emit('getBoardData');


            function displayBoardHtml(revealedBoard, remainingMineCount) {

                //Get board data
                var boardArray = revealedBoard;
                boardElement.setAttribute('style', 'width: ' + 52 * boardArray.length + 'px');

                //Initialize empty board
                if (!Boolean(boardElement.firstElementChild)) {

                    //Build row
                    for (var y = 0; y < boardArray[0].length; y++) {
                        var rowElement = document.createElement('div');
                        rowElement.setAttribute('class', 'row');

                        //Build cell
                        for (var x = 0; x < boardArray.length; x++) {
                            var cellElement = document.createElement('div');

                            //Set data
                            cellElement.setAttribute('data-x', x);
                            cellElement.setAttribute('data-y', y);

                            //Set class
                            cellElement.setAttribute('class', 'cell unknown');

                            //Set text
                            var textElement = document.createTextNode('');

                            //Set click handlers
                            cellElement.addEventListener('click', function (e) {
                                e.preventDefault();
                                handleCellClick.call(this, 'click');
                                return false;
                            });
                            cellElement.addEventListener('contextmenu', function (e) {
                                e.preventDefault();
                                handleCellClick.call(this, 'contextmenu');
                                return false;
                            });

                            //Attach                            
                            cellElement.appendChild(textElement);
                            rowElement.appendChild(cellElement);
                        }
                        boardElement.appendChild(rowElement);
                    }
                }

                //Update existing board
                for (var y = 0; y < boardElement.childNodes.length - 1; y++) {
                    var rowElement = boardElement.childNodes[y + 1];
                    for (var x = 0; x < rowElement.childNodes.length; x++) {
                        var cellElement = rowElement.childNodes[x];

                        //Set class and text
                        var cellClass;
                        var cellText;
                        if (boardArray[x][y].isRevealed) {
                            cellClass = 'cell revealed';
                            cellText = boardArray[x][y].mineCount;
                        } else if (boardArray[x][y].isFlagged) {
                            cellClass = 'cell flagged';
                            cellText = 'F';
                        } else {
                            cellClass = 'cell unknown';
                            cellText = '';
                        }
                        if (cellElement.getAttribute('class') !== cellClass)
                            cellElement.setAttribute('class', cellClass);
                        if (cellElement.childNodes[0].textContent !== cellText) {
                            cellElement.removeChild(cellElement.childNodes[0]);
                            cellElement.appendChild(document.createTextNode(cellText));
                        }
                    }
                }

                //Set remaining mines
                var remainingMineCountElement = document.getElementById('remaining-mine-count');
                while (remainingMineCountElement.firstChild)
                    remainingMineCountElement.removeChild(remainingMineCountElement.firstChild);
                remainingMineCountElement.appendChild(document.createTextNode(remainingMineCount));
            }


            function handleCellClick(event) {

                //Get coordinates
                var x = Number(this.getAttribute('data-x'));
                var y = Number(this.getAttribute('data-y'));

                //Left click
                if (event === 'click') {
                    socket.emit('revealSquare', {
                        x: x,
                        y: y
                    });
                }

                //Right click
                else if (event === 'contextmenu') {
                    socket.emit('toggleFlag', {
                        x: x,
                        y: y
                    });
                }
            }
        })();
    </script>
</body>

</html>